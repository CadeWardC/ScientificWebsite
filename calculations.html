<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculations - Scientific Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-black: #0a0a0a;
            --soft-black: #1a1a1a;
            --pure-white: #ffffff;
            --off-white: #f8f9fa;
            --muted-blue: #4a90a4;
            --light-blue: rgba(74, 144, 164, 0.1);
            --border-color: rgba(74, 144, 164, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--primary-black);
            background: var(--pure-white);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-black);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--primary-black);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--muted-blue);
        }

        /* Dropdown CSS */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--pure-white);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 8px;
            padding: 0.5rem 0;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .dropdown-content a {
            color: var(--primary-black);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .dropdown-content a:hover {
            background-color: var(--off-white);
            color: var(--muted-blue);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropbtn {
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            padding-top: 100px;
            /* Space for fixed header */
            min-height: 80vh;
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-black);
        }

        .section-header p {
            font-size: 1.1rem;
            color: rgba(10, 10, 10, 0.6);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Footer */
        footer {
            background: var(--soft-black);
            color: var(--pure-white);
            padding: 3rem 0;
            text-align: center;
            margin-top: 4rem;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-section h3 {
            margin-bottom: 1rem;
            color: var(--muted-blue);
        }

        .footer-section a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            display: block;
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }

        .footer-section a:hover {
            color: var(--muted-blue);
        }

        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .container {
                padding: 0 1rem;
            }
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 1rem 2rem;
            background: var(--pure-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-black);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            border-color: var(--muted-blue);
            color: var(--muted-blue);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: var(--muted-blue);
            color: var(--pure-white);
            border-color: var(--muted-blue);
            box-shadow: 0 4px 15px rgba(74, 144, 164, 0.3);
        }

        .tab-content {
            display: none;
            background: var(--pure-white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Calculator Forms */
        .calc-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: var(--soft-black);
        }

        .form-group input,
        .form-group select {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--muted-blue);
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group input {
            flex: 2;
        }

        .input-group select {
            flex: 1;
            min-width: 80px;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f8f9fa;
            cursor: pointer;
        }

        .calc-btn {
            padding: 1rem;
            background: var(--muted-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 1rem;
        }

        .calc-btn:hover {
            background: #3a7a8c;
        }

        .result-box {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--off-white);
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--muted-blue);
            margin-top: 0.5rem;
        }

        .saved-item {
            background-color: var(--pure-white);
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: transform 0.2s;
        }

        .saved-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .saved-header {
            font-weight: 700;
            color: var(--primary-black);
            font-size: 1.05rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-details {
            font-family: monospace;
            color: var(--soft-black);
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        /* Grouping Styles */
        .group-container {
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            background: var(--pure-white);
        }

        .group-header {
            background: #f1f3f5;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--primary-black);
            user-select: none;
            transition: background 0.2s;
        }

        .group-header:hover {
            background: #e9ecef;
        }

        .group-header .group-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .group-header .toggle-icon {
            transition: transform 0.3s;
        }

        .group-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .group-content {
            padding: 1rem;
            border-top: 1px solid #eee;
            display: block;
        }

        .group-content.collapsed {
            display: none;
        }

        .group-actions {
            display: flex;
            gap: 0.5rem;
        }

        .group-btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            padding: 2px;
            font-size: 1rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .group-btn-icon:hover {
            opacity: 1;
            color: var(--muted-blue);
        }

        .group-btn-icon.delete:hover {
            color: #dc3545;
        }

        .delete-item-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
            padding: 0 0.5rem;
        }

        .delete-item-btn:hover {
            color: #dc3545;
        }

        /* Modal for Group Creation */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
    </style>
</head>

<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">Scientific Tools</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Tools ‚ñæ</a>
                    <div class="dropdown-content">
                        <a href="gelelectrophoresis.html">Gel Analysis</a>
                        <a href="sequencer.html">Sequencer</a>
                        <a href="calculations.html">Calculations</a>
                        <a href="size_exclusion_graphing.html">Size Exclusion Graphing</a>
                        <a href="timing.html">Timing</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="main-content container">
        <div class="section-header">
            <h1>Scientific Calculations</h1>
            <p>Perform common laboratory calculations with ease and precision.</p>
        </div>

        <div id="calculator-container">
            <div class="tabs-container">
                <button class="tab-button active" onclick="openTab('dilution', this)">Dilution Calculation</button>
                <button class="tab-button" onclick="openTab('molarity', this)">Molarity Calculation</button>
                <button class="tab-button" onclick="openTab('transfection', this)">Transfection Calculation</button>
            </div>

            <div id="dilution" class="tab-content active">
                <h2>Dilution Calculator</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">Calculate the volume needed to dilute a stock solution to
                    a desired concentration (C1V1 = C2V2).</p>
                <div class="calc-form">
                    <div class="form-group">
                        <label>Final Concentration (C2)</label>
                        <div class="input-group">
                            <input type="number" id="dil-c2" placeholder="e.g., 10">
                            <select id="dil-c2-unit">
                                <option value="1">M</option>
                                <option value="1e-3">mM</option>
                                <option value="1e-6">¬µM</option>
                                <option value="1e-9">nM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Final Volume (V2)</label>
                        <div class="input-group">
                            <input type="number" id="dil-v2" placeholder="e.g., 50">
                            <select id="dil-v2-unit">
                                <option value="1">L</option>
                                <option value="1e-3" selected>mL</option>
                                <option value="1e-6">¬µL</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Initial Concentration (C1)</label>
                        <div class="input-group">
                            <input type="number" id="dil-c1" placeholder="e.g., 100">
                            <select id="dil-c1-unit">
                                <option value="1">M</option>
                                <option value="1e-3">mM</option>
                                <option value="1e-6">¬µM</option>
                                <option value="1e-9">nM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Initial Volume (V1)</label>
                        <div class="input-group">
                            <input type="number" id="dil-v1" placeholder="Calculated by default">
                            <select id="dil-v1-unit">
                                <option value="1">L</option>
                                <option value="1e-3" selected>mL</option>
                                <option value="1e-6">¬µL</option>
                            </select>
                        </div>
                    </div>
                    <button class="calc-btn" onclick="calculateDilution()">Calculate</button>
                    <!-- Save/Reset Controls -->
                    <div class="save-controls"
                        style="display:flex; flex-direction:column; gap:0.5rem; margin-top:0.5rem;">
                        <div style="display:flex; gap:0.5rem;">
                            <input type="text" id="dil-save-name" placeholder="Name this calculation"
                                style="flex:2; padding:0.8rem; border:1px solid #ddd; border-radius:6px;">
                            <select id="dil-group-select"
                                style="flex:1; padding:0.8rem; border:1px solid #ddd; border-radius:6px;">
                                <option value="default">All Calculations</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:0.5rem;">
                            <button class="calc-btn" onclick="openCreateGroupModal('dilution')"
                                style="margin-top:0; flex:1; background:var(--muted-blue); opacity:0.8;">+ New
                                Group</button>
                            <button class="calc-btn" onclick="saveDilution()"
                                style="margin-top:0; flex:1; background:var(--soft-black);">Save</button>
                            <button class="calc-btn" onclick="resetDilution()"
                                style="margin-top:0; flex:1; background:#dc3545;">Reset Inputs</button>
                            <button class="calc-btn" onclick="clearAllDilutionData()"
                                style="margin-top:0; flex:1; background:#c82333;">Clear All</button>
                        </div>
                    </div>
                </div>
                <div id="dil-result" class="result-box">
                    <h3>Result</h3>
                    <div class="result-value" id="dil-output"></div>
                </div>
                <div id="dil-saved-list" style="margin-top: 2rem;">
                    <!-- Saved items will appear here -->
                </div>
            </div>

            <div id="molarity" class="tab-content">
                <h2>Molarity Calculator</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">Calculate the mass required to prepare a solution of
                    specific molarity.</p>
                <div class="calc-form">
                    <div class="form-group">
                        <label>Molecular Weight (g/mol)</label>
                        <input type="number" id="mol-mw" placeholder="e.g., 58.44">
                    </div>
                    <div class="form-group">
                        <label>Desired Concentration</label>
                        <div class="input-group">
                            <input type="number" id="mol-conc" placeholder="e.g., 0.5">
                            <select id="mol-conc-unit">
                                <option value="1">M</option>
                                <option value="1e-3">mM</option>
                                <option value="1e-6">¬µM</option>
                                <option value="1e-9">nM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Desired Volume</label>
                        <div class="input-group">
                            <input type="number" id="mol-vol" placeholder="e.g., 1">
                            <select id="mol-vol-unit">
                                <option value="1">L</option>
                                <option value="1e-3">mL</option>
                                <option value="1e-6">¬µL</option>
                            </select>
                        </div>
                    </div>
                    <button class="calc-btn" onclick="calculateMolarity()">Calculate Mass</button>
                    <!-- Save/Reset Controls -->
                    <div class="save-controls"
                        style="display:flex; flex-direction:column; gap:0.5rem; margin-top:0.5rem;">
                        <div style="display:flex; gap:0.5rem;">
                            <input type="text" id="mol-save-name" placeholder="Name this calculation"
                                style="flex:2; padding:0.8rem; border:1px solid #ddd; border-radius:6px;">
                            <select id="mol-group-select"
                                style="flex:1; padding:0.8rem; border:1px solid #ddd; border-radius:6px;">
                                <option value="default">All Calculations</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:0.5rem;">
                            <button class="calc-btn" onclick="openCreateGroupModal('molarity')"
                                style="margin-top:0; flex:1; background:var(--muted-blue); opacity:0.8;">+ New
                                Group</button>
                            <button class="calc-btn" onclick="saveMolarity()"
                                style="margin-top:0; flex:1; background:var(--soft-black);">Save</button>
                            <button class="calc-btn" onclick="resetMolarity()"
                                style="margin-top:0; flex:1; background:#dc3545;">Reset Inputs</button>
                            <button class="calc-btn" onclick="clearAllMolarityData()"
                                style="margin-top:0; flex:1; background:#c82333;">Clear All</button>
                        </div>
                    </div>
                </div>
                <div id="mol-result" class="result-box">
                    <h3>Required Mass</h3>
                    <div class="result-value" id="mol-output"></div>
                </div>
                <div id="mol-saved-list" style="margin-top: 2rem;">
                    <!-- Saved items will appear here -->
                </div>
            </div>

            <div id="transfection" class="tab-content">
                <h2>Transfection Calculator</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">Calculate the amount of DNA needed for transfection.</p>

                <!-- Section 1 -->
                <div class="calc-section"
                    style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid #eee;">
                    <h3>DNA Volume Calculation</h3>
                    <div class="calc-form">
                        <div class="form-group">
                            <label>Volume of Culture (mL)</label>
                            <input type="number" id="trans-vol-culture" placeholder="e.g., 10">
                        </div>
                        <div class="form-group">
                            <label>DNA Concentration (ng/¬µL)</label>
                            <input type="number" id="trans-dna-conc" placeholder="e.g., 100">
                        </div>
                        <button class="calc-btn" onclick="calculateTransfectionSection1()">Calculate DNA Volume</button>
                    </div>
                    <div id="trans-result-1" class="result-box">
                        <h3>Required DNA Volume</h3>
                        <div class="result-value" id="trans-output-1"></div>
                    </div>
                </div>

                <!-- Section 2 -->
                <div class="calc-section">
                    <h3>PEI Calculation</h3>
                    <div class="calc-form">
                        <div class="form-group">
                            <label>PEI Concentration (mg/mL)</label>
                            <input type="number" id="trans-pei-conc" value="1">
                        </div>
                        <div class="form-group">
                            <label>PEI Multiplier</label>
                            <input type="number" id="trans-pei-mult" value="4">
                        </div>
                        <button class="calc-btn" onclick="calculateTransfectionSection2()">Calculate PEI Volume</button>
                    </div>
                    <div id="trans-result-2" class="result-box">
                        <h3>Required PEI Volume</h3>
                        <div class="result-value" id="trans-output-2"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Add Group Modal -->
        <div id="groupModal" class="modal">
            <div class="modal-content">
                <h3>Create New Group</h3>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Group Name</label>
                    <input type="text" id="new-group-name" placeholder="e.g., Week 1 Experiments">
                </div>
                <div class="modal-buttons">
                    <button class="calc-btn" onclick="closeGroupModal()"
                        style="margin:0; background:#6c757d;">Cancel</button>
                    <button class="calc-btn" onclick="confirmCreateGroup()" style="margin:0;">Create</button>
                </div>
            </div>
        </div>

        <script>
            // Unified State Management (Session Only)
            let appState = {
                inputs: {
                    dilution: { c1: '', v1: '', c2: '', v2: '', units: {} },
                    molarity: { mw: '', conc: '', vol: '', units: {} }
                },
                savedItems: [], // Array of { id, name, values, group, timestamp, type }
                groups: [],     // Array of { id, name }
                activeModal: null // 'dilution' or 'molarity' (used for triggering context)
            };

            function init() {
                // Initialize lists (will be empty on load)
                renderAllLists();
                updateAllGroupSelects();

                // Add event listeners to capture inputs in real-time (for tab switching preservation)
                // We don't save to localStorage, but we keep appState.inputs updated so we can
                // potentially restore them if we implemented logic for that, 
                // but currently the DOM keeps the state when switching tabs anyway 
                // because we just hide/show divs. 
                // However, let's keep appState updated for good measure.
                document.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('change', captureInputs);
                    el.addEventListener('input', captureInputs);
                });
            }

            function captureInputs() {
                // Dilution
                appState.inputs.dilution = {
                    c1: document.getElementById('dil-c1').value,
                    v1: document.getElementById('dil-v1').value,
                    c2: document.getElementById('dil-c2').value,
                    v2: document.getElementById('dil-v2').value,
                    units: {
                        c1: document.getElementById('dil-c1-unit').value,
                        v1: document.getElementById('dil-v1-unit').value,
                        c2: document.getElementById('dil-c2-unit').value,
                        v2: document.getElementById('dil-v2-unit').value
                    }
                };

                // Molarity
                appState.inputs.molarity = {
                    mw: document.getElementById('mol-mw').value,
                    conc: document.getElementById('mol-conc').value,
                    vol: document.getElementById('mol-vol').value,
                    units: {
                        conc: document.getElementById('mol-conc-unit').value,
                        vol: document.getElementById('mol-vol-unit').value
                    }
                };
            }

            function openTab(tabId, btn) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Deactivate all buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                // Show selected tab
                document.getElementById(tabId).classList.add('active');

                // Activate button
                btn.classList.add('active');
            }

            // ---- Unified Grouping Logic ----

            function openCreateGroupModal(type) {
                appState.activeModal = type;
                document.getElementById('groupModal').classList.add('show');
                document.getElementById('new-group-name').focus();
            }

            function closeGroupModal() {
                document.getElementById('groupModal').classList.remove('show');
                document.getElementById('new-group-name').value = '';
                appState.activeModal = null;
            }

            function confirmCreateGroup() {
                const name = document.getElementById('new-group-name').value.trim();

                if (!name) return;

                const newGroup = {
                    id: 'g_' + Date.now(),
                    name: name
                };

                appState.groups.push(newGroup);

                updateAllGroupSelects();
                renderAllLists();
                closeGroupModal();

                // Select the new group in the active context
                if (appState.activeModal) {
                    const selectorId = appState.activeModal === 'dilution' ? 'dil-group-select' : 'mol-group-select';
                    document.getElementById(selectorId).value = newGroup.id;
                }
            }

            function updateAllGroupSelects() {
                ['dilution', 'molarity'].forEach(type => {
                    const select = document.getElementById(`${type === 'dilution' ? 'dil' : 'mol'}-group-select`);
                    // Save current selection to restore it if possible
                    const currentVal = select.value;

                    // Reset options
                    select.innerHTML = '<option value="default">All Calculations</option>';

                    appState.groups.forEach(g => {
                        const opt = document.createElement('option');
                        opt.value = g.id;
                        opt.textContent = g.name;
                        select.appendChild(opt);
                    });

                    // Restore selection if it still exists
                    if (Array.from(select.options).some(o => o.value === currentVal)) {
                        select.value = currentVal;
                    }
                });
            }

            function deleteGroup(groupId) {
                if (confirm('Delete this group? Calculations will be ungrouped.')) {
                    // Remove group
                    appState.groups = appState.groups.filter(g => g.id !== groupId);

                    // Ungroup items
                    appState.savedItems.forEach(item => {
                        if (item.group === groupId) {
                            item.group = 'default';
                        }
                    });

                    updateAllGroupSelects();
                    renderAllLists();
                }
            }

            function toggleGroup(header) {
                header.classList.toggle('collapsed');
                const content = header.nextElementSibling;
                content.classList.toggle('collapsed');
            }

            function renderAllLists() {
                renderList('dilution');
                renderList('molarity');
            }

            function renderList(viewContext) {
                const containerId = viewContext === 'dilution' ? 'dil-saved-list' : 'mol-saved-list';
                const container = document.getElementById(containerId);
                container.innerHTML = '';

                // We display ALL items in both tabs (unified list)

                const items = appState.savedItems;
                const groups = appState.groups;

                // Helper to create item HTML
                const createItemHTML = (item) => {
                    const isDilution = item.type === 'dilution';

                    if (isDilution) {
                        return `
                        <div class="saved-item" style="margin-bottom:0.5rem; border-left: 4px solid var(--muted-blue);">
                           <div class="saved-details" style="display:flex; align-items:center; gap: 1rem; background:none; padding:0;">
                                <span style="font-size:0.8rem; color:#666; width:20px;" title="Dilution">D</span>
                                <span style="min-width: 80px;">${item.values.c1}</span>
                                <span style="font-weight:700; flex:1;">${item.name}</span>
                                <span style="min-width: 80px;">${item.values.v1}</span>
                                <span style="min-width: 80px;">${item.values.c2}</span>
                                <button class="delete-item-btn" onclick="deleteItem('${item.id}')">√ó</button>
                            </div>
                        </div>`;
                    } else {
                        return `
                        <div class="saved-item" style="margin-bottom:0.5rem; border-left: 4px solid var(--soft-black);">
                            <div class="saved-header" style="justify-content:flex-start; gap:1rem;">
                                <span style="font-size:0.8rem; color:#666; width:20px;" title="Molarity">M</span>
                                <span>${item.name}</span>
                                <button class="delete-item-btn" style="margin-left:auto;" onclick="deleteItem('${item.id}')">√ó</button>
                            </div>
                            <div class="saved-details">
                                MW: ${item.values.mw} | Conc: ${item.values.conc} | Vol: ${item.values.vol} ‚Üí Mass: <b>${item.values.mass}</b>
                            </div>
                        </div>`;
                    }
                };

                // 1. Render groups
                groups.forEach(group => {
                    const groupItems = items.filter(i => i.group === group.id);

                    const groupHTML = document.createElement('div');
                    groupHTML.className = 'group-container';
                    groupHTML.innerHTML = `
                        <div class="group-header" onclick="toggleGroup(this)">
                            <div class="group-title">
                                <span class="toggle-icon">‚ñº</span>
                                <span>${group.name} (${groupItems.length})</span>
                            </div>
                            <div class="group-actions" onclick="event.stopPropagation()">
                                <button class="group-btn-icon delete" title="Delete Group" onclick="deleteGroup('${group.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="group-content">
                            ${groupItems.length ? groupItems.map(createItemHTML).join('') : '<p style="color:#999; font-size:0.9rem;">No calculations</p>'}
                        </div>
                    `;
                    container.appendChild(groupHTML);
                });

                // 2. Render ungrouped items
                const ungroupedItems = items.filter(i => !i.group || i.group === 'default');
                if (ungroupedItems.length > 0) {
                    const groupHTML = document.createElement('div');
                    groupHTML.className = 'group-container';
                    groupHTML.innerHTML = `
                        <div class="group-header" onclick="toggleGroup(this)">
                            <div class="group-title">
                                <span class="toggle-icon">‚ñº</span>
                                <span>All Calculations (${ungroupedItems.length})</span>
                            </div>
                        </div>
                        <div class="group-content">
                             ${ungroupedItems.map(createItemHTML).join('')}
                        </div>
                    `;
                    container.appendChild(groupHTML);
                }
            }

            function deleteItem(id) {
                if (confirm('Delete this calculation?')) {
                    appState.savedItems = appState.savedItems.filter(i => i.id !== id);
                    renderAllLists();
                }
            }

            function clearAllDilutionData() {
                if (confirm('Clear Dilution inputs? Saved items will remain.')) {
                    // Only clear inputs
                    document.getElementById('dil-c1').value = '';
                    document.getElementById('dil-v1').value = '';
                    document.getElementById('dil-c2').value = '';
                    document.getElementById('dil-v2').value = '';
                    document.getElementById('dil-result').classList.remove('show');
                    captureInputs();
                }
            }
            function clearAllMolarityData() {
                if (confirm('Clear Molarity inputs? Saved items will remain.')) {
                    // Only clear inputs
                    document.getElementById('mol-mw').value = '';
                    document.getElementById('mol-conc').value = '';
                    document.getElementById('mol-vol').value = '';
                    document.getElementById('mol-result').classList.remove('show');
                    captureInputs();
                }
            }

            // ---- Calculation Logic ----

            function calculateDilution() {
                const c1Val = document.getElementById('dil-c1').value;
                const v1Val = document.getElementById('dil-v1').value;
                const c2Val = document.getElementById('dil-c2').value;
                const v2Val = document.getElementById('dil-v2').value;

                const c1Unit = parseFloat(document.getElementById('dil-c1-unit').value);
                const v1Unit = parseFloat(document.getElementById('dil-v1-unit').value);
                const c2Unit = parseFloat(document.getElementById('dil-c2-unit').value);
                const v2Unit = parseFloat(document.getElementById('dil-v2-unit').value);

                // Convert inputs to base units (Molar and Liter)
                const c1 = parseFloat(c1Val) * c1Unit;
                const v1 = parseFloat(v1Val) * v1Unit;
                const c2 = parseFloat(c2Val) * c2Unit;
                const v2 = parseFloat(v2Val) * v2Unit;

                const resultBox = document.getElementById('dil-result');
                const output = document.getElementById('dil-output');

                // Check which fields are provided
                const hasC1 = !isNaN(c1) && c1Val !== '';
                const hasV1 = !isNaN(v1) && v1Val !== '';
                const hasC2 = !isNaN(c2) && c2Val !== '';
                const hasV2 = !isNaN(v2) && v2Val !== '';

                // Count filled fields
                const filledCount = [hasC1, hasV1, hasC2, hasV2].filter(Boolean).length;

                if (filledCount < 3) {
                    alert('Please fill in at least 3 fields.');
                    return;
                }

                // Helper to get unit label
                const getUnitLabel = (id) => {
                    const sel = document.getElementById(id);
                    return sel.options[sel.selectedIndex].text;
                };

                // Priority Logic: Calculate empty field, or default to V1 if all full
                let resultField = '';

                if (!hasC1) {
                    // Calculate C1 = (C2 * V2) / V1
                    const calculatedC1_M = (c2 * v2) / v1;
                    const calculatedC1 = calculatedC1_M / c1Unit;
                    document.getElementById('dil-c1').value = calculatedC1.toPrecision(4);
                    output.textContent = `${calculatedC1.toPrecision(4)} ${getUnitLabel('dil-c1-unit')}`;
                    resultField = 'dil-c1';
                } else if (!hasC2) {
                    // Calculate C2 = (C1 * V1) / V2
                    const calculatedC2_M = (c1 * v1) / v2;
                    const calculatedC2 = calculatedC2_M / c2Unit;
                    document.getElementById('dil-c2').value = calculatedC2.toPrecision(4);
                    output.textContent = `${calculatedC2.toPrecision(4)} ${getUnitLabel('dil-c2-unit')}`;
                    resultField = 'dil-c2';
                } else if (!hasV2) {
                    // Calculate V2 = (C1 * V1) / C2
                    const calculatedV2_L = (c1 * v1) / c2;
                    const calculatedV2 = calculatedV2_L / v2Unit;
                    document.getElementById('dil-v2').value = calculatedV2.toPrecision(4);
                    output.textContent = `${calculatedV2.toPrecision(4)} ${getUnitLabel('dil-v2-unit')}`;
                    resultField = 'dil-v2';
                } else {
                    // Default: Calculate V1 
                    const calculatedV1_L = (c2 * v2) / c1;
                    const calculatedV1 = calculatedV1_L / v1Unit;
                    document.getElementById('dil-v1').value = calculatedV1.toPrecision(4);
                    output.textContent = `${calculatedV1.toPrecision(4)} ${getUnitLabel('dil-v1-unit')}`;
                    resultField = 'dil-v1';
                }
                resultBox.classList.add('show');
                // Store result field for saving
                document.getElementById('calculator-container').dataset.dilLastCalc = resultField;
                captureInputs();
            }

            function resetDilution() {
                document.getElementById('dil-c1').value = '';
                document.getElementById('dil-v1').value = '';
                document.getElementById('dil-c2').value = '';
                document.getElementById('dil-v2').value = '';
                document.getElementById('dil-result').classList.remove('show');
                captureInputs();
            }

            function saveDilution() {
                const name = document.getElementById('dil-save-name').value;
                const groupId = document.getElementById('dil-group-select').value;

                if (!name) { alert('Please enter a name'); return; }

                // Auto-calculate
                calculateDilution();
                if (!document.getElementById('dil-result').classList.contains('show')) return;

                const c1 = document.getElementById('dil-c1').value + ' ' + document.querySelector('#dil-c1-unit option:checked').text;
                const v1 = document.getElementById('dil-v1').value + ' ' + document.querySelector('#dil-v1-unit option:checked').text;
                const c2 = document.getElementById('dil-c2').value + ' ' + document.querySelector('#dil-c2-unit option:checked').text;
                const v2 = document.getElementById('dil-v2').value + ' ' + document.querySelector('#dil-v2-unit option:checked').text;

                const calcField = document.getElementById('calculator-container').dataset.dilLastCalc;
                const format = (id, val) => id === calcField ? `<b>${val}</b>` : val;

                const newItem = {
                    id: 'd_' + Date.now(),
                    type: 'dilution',
                    name: name,
                    group: groupId,
                    values: {
                        c1: format('dil-c1', c1),
                        v1: format('dil-v1', v1),
                        c2: format('dil-c2', c2),
                        v2: format('dil-v2', v2)
                    },
                    timestamp: Date.now()
                };

                appState.savedItems.push(newItem);
                renderAllLists();
                document.getElementById('dil-save-name').value = '';
            }

            function calculateMolarity() {
                const mw = parseFloat(document.getElementById('mol-mw').value);
                const conc = parseFloat(document.getElementById('mol-conc').value);
                const vol = parseFloat(document.getElementById('mol-vol').value);

                const concUnit = parseFloat(document.getElementById('mol-conc-unit').value);
                const volUnit = parseFloat(document.getElementById('mol-vol-unit').value);

                if (isNaN(mw) || isNaN(conc) || isNaN(vol)) {
                    alert('Please fill in all fields.');
                    return;
                }

                const molarity = conc * concUnit;
                const volume = vol * volUnit;
                const mass = mw * molarity * volume;

                let displayMass = mass;
                let unit = 'g';

                if (mass < 1e-3) {
                    displayMass = mass * 1e6;
                    unit = '¬µg';
                } else if (mass < 1) {
                    displayMass = mass * 1e3;
                    unit = 'mg';
                }

                const output = document.getElementById('mol-output');
                const massStr = `${displayMass.toPrecision(4)} ${unit}`;
                output.textContent = massStr;
                document.getElementById('mol-result').classList.add('show');

                document.getElementById('calculator-container').dataset.molLastMass = massStr;
                captureInputs();
            }

            function resetMolarity() {
                document.getElementById('mol-mw').value = '';
                document.getElementById('mol-conc').value = '';
                document.getElementById('mol-vol').value = '';
                document.getElementById('mol-result').classList.remove('show');
                captureInputs();
            }

            function saveMolarity() {
                const name = document.getElementById('mol-save-name').value;
                const groupId = document.getElementById('mol-group-select').value;

                if (!name) { alert('Please enter a name'); return; }

                // Auto-calculate
                calculateMolarity();
                if (!document.getElementById('mol-result').classList.contains('show')) return;

                const mw = document.getElementById('mol-mw').value + ' g/mol';
                const conc = document.getElementById('mol-conc').value + ' ' + document.querySelector('#mol-conc-unit option:checked').text;
                const vol = document.getElementById('mol-vol').value + ' ' + document.querySelector('#mol-vol-unit option:checked').text;
                const mass = document.getElementById('calculator-container').dataset.molLastMass;

                const newItem = {
                    id: 'm_' + Date.now(),
                    type: 'molarity',
                    name: name,
                    group: groupId,
                    values: {
                        mw, conc, vol, mass
                    },
                    timestamp: Date.now()
                };

                appState.savedItems.push(newItem);
                renderAllLists();
                document.getElementById('mol-save-name').value = '';
            }

            function calculateTransfectionSection1() {
                const volCulture = parseFloat(document.getElementById('trans-vol-culture').value);
                const dnaConc = parseFloat(document.getElementById('trans-dna-conc').value);
                const resultBox = document.getElementById('trans-result-1');
                const output = document.getElementById('trans-output-1');

                if (isNaN(volCulture) || isNaN(dnaConc) || dnaConc === 0) {
                    alert('Please enter valid numbers. Concentration cannot be zero.');
                    return;
                }

                // User instruction logic
                const effectiveDnaConc = dnaConc / 1000;
                const result = volCulture / effectiveDnaConc;

                output.innerHTML = `${result.toPrecision(4)} ¬µL`;
                resultBox.classList.add('show');
            }

            function calculateTransfectionSection2() {
                const volCulture = parseFloat(document.getElementById('trans-vol-culture').value);
                const peiConc = parseFloat(document.getElementById('trans-pei-conc').value);
                const peiMult = parseFloat(document.getElementById('trans-pei-mult').value);

                const resultBox = document.getElementById('trans-result-2');
                const output = document.getElementById('trans-output-2');

                if (isNaN(volCulture)) {
                    alert('Please enter a Volume of Culture in the first section.');
                    return;
                }
                if (isNaN(peiConc) || isNaN(peiMult) || peiConc === 0) {
                    alert('Please enter valid numbers for PEI calculation. Concentration cannot be zero.');
                    return;
                }

                // Logic: (Culture Volume * PEI Multiplier) / PEI Concentration
                const rawResult = (volCulture * peiMult) / peiConc;
                const result = rawResult / 1000;

                output.innerHTML = `${result.toFixed(1)} mL`;
                resultBox.classList.add('show');
            }

            // Initialize app
            window.addEventListener('DOMContentLoaded', init);

            // Add input listeners for auto-save state
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', captureInputs);
                el.addEventListener('input', captureInputs);
            });

        </script>
    </main>

    <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>CadeWardInc</h3>
                    <a href="#">About Us</a>
                    <a href="#">Contact</a>
                </div>
                <div class="footer-section">
                    <h3>Tools</h3>
                    <a href="gelelectrophoresis.html">Gel Analysis</a>
                    <a href="sequencer.html">Sequencer</a>
                    <a href="calculations.html">Calculations</a>
                    <a href="size_exclusion_graphing.html">Size Exclusion Graphing</a>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 CadeWardInc. All rights reserved. | Advanced scientific analysis tools.</p>
            </div>
        </div>
    </footer>
</body>

</html>